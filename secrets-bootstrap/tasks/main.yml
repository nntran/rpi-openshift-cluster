---
# run_once: create k8s secrets from ansible-vaulted variables
- name: Ensure cert-manager namespace exists
  kubernetes.core.k8s:
    state: present
    kind: Namespace
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: cert-manager
  run_once: true

- name: Create cloudflare api token secret for cert-manager
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: cloudflare-api-token-secret
        namespace: cert-manager
      type: Opaque
      stringData:
        api-token: "{{ vault.cloudflare_api_token }}"
  run_once: true

- name: Create gitea admin secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: gitea-admin
        namespace: gitea
      type: Opaque
      stringData:
        admin-password: "{{ vault.gitea_admin_password }}"
  run_once: true

- name: Create docker registry credentials secret (example for pushing built images)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: reg-cred
        namespace: nexus
      type: kubernetes.io/dockerconfigjson
      stringData:
        .dockerconfigjson: "{{ lookup('template', 'dockerconfigjson.j2') }}"
  run_once: true
